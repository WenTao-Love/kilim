# Kilim 项目开发指南

## 概述

本文档为 Kilim 项目团队提供开发规范、最佳实践和协作指南，帮助团队高效、规范地进行开发工作。

## 一、项目架构理解

### 1.1 核心概念

协程（Fiber）：轻量级线程，包含自己的栈，通过 yield/pause 实现协作式多任务

任务（Task）：继承协程能力，实现可暂停的 execute 方法，由调度器管理执行

调度器（Scheduler）：管理任务队列，分派工作线程，实现负载均衡

消息传递（Mailbox/Cell）：类型化消息缓冲，支持生产者-消费者模式，事件驱动通知

### 1.2 设计原则

协程优先：优先使用协程而非线程，避免阻塞操作，利用 yield 实现协作

非阻塞 I/O：使用 NIO 进行网络操作，避免线程阻塞，提高并发性能

事件驱动：使用 EventPublisher/EventSubscriber 实现松耦合通信，支持异步通知

资源管理：及时释放资源，避免内存泄漏，使用 try-with-resources

## 二、开发心得体会

### 2.1 协程使用心得

协程不是线程，是用户态线程，协程的栈由用户管理，上下文切换比线程快，适合 I/O 密集型任务

yield 的正确使用：在适当的时候让出控制，避免过度的 yield，在循环中合理使用 yield

pause 的使用场景：等待消息时使用 pause，等待 I/O 完成时使用 pause，配合 Mailbox/Cell 使用

### 2.2 消息传递心得

Mailbox 的使用：支持多生产者单消费者，适合任务间通信，支持阻塞和非阻塞操作

Cell 的使用：单元素缓冲区，适合简单同步场景，支持事件通知，注意避免死锁

事件驱动模式：使用 EventPublisher 发布事件，使用 EventSubscriber 订阅事件，实现松耦合通信

### 2.3 调度器使用心得

调度器选择：默认调度器适合通用场景，AffineScheduler 适合 CPU 密集型任务，ForkJoinScheduler 适合并行计算

线程亲和性：某些场景需要固定线程，使用 pinToThread() 方法，注意线程切换开销

## 三、开发规范

### 3.1 代码风格

命名规范：类名使用大驼峰命名，方法名使用小驼峰命名，常量名使用全大写下划线

注释规范：类级别注释说明类的用途、设计思路，方法级别注释说明方法功能、参数、返回值，必须包含 @param、@return、@throws 标签

代码格式：使用 4 空格缩进，每行代码不超过 120 字符，大括号对齐，适当使用空行分隔逻辑块

### 3.2 Git 工作流

分支策略：主分支包括 main、develop、feature、bugfix，功能分支按功能模块命名，修复分支按问题编号命名

提交规范：提交信息格式为 类型(范围): 简要描述，提交类型包括 feat、fix、docs、refactor、perf、test、chore

代码审查：使用 Pull Request 进行代码审查，至少需要一人审查，审查要点包括代码风格、注释完整性、异常处理、资源管理

合并规范：合并前先更新代码，使用 rebase 而非 merge，手动解决冲突，合并后运行测试

### 3.3 测试规范

单元测试：每个功能模块必须有对应的单元测试，测试覆盖率要求至少 80%，使用 JUnit 或 TestNG 框架

集成测试：测试模块间集成，测试端到端功能，使用 Mock 对象隔离依赖

性能测试：吞吐量测试、延迟测试、资源利用率测试，使用性能分析工具进行优化

## 四、注意事项

### 4.1 协程使用注意事项

避免阻塞操作：在协程中不要调用 Thread.sleep()、Object.wait() 等阻塞方法，使用非阻塞 I/O 操作

资源释放：使用 try-with-resources 或 finally 块确保释放，及时关闭 EndPoint、FileChannel 等资源

异常处理：不要忽略异常，记录详细的错误信息，提供错误恢复机制，正确处理 Pausable 异常

### 4.2 线程安全注意事项

并发控制：使用 AtomicInteger 等原子类，使用 volatile 保证可见性，正确使用 synchronized 块

锁的使用：锁的粒度要合适，避免长时间持有锁，使用 try-finally 确保锁释放

### 4.3 HTTP 特定注意事项

请求处理：验证所有输入参数，防止注入攻击（XSS、SQL 注入），设置合理的超时时间，限制请求大小

响应安全：设置正确的状态码，添加必要的响应头，防止敏感信息泄露，考虑响应压缩

## 五、团队协作

### 5.1 沟通规范

沟通机制：定期代码同步，使用统一的代码风格，及时解决冲突

知识共享：维护技术文档，分享最佳实践，定期技术分享会

问题跟踪：使用 Issue 跟踪系统，记录问题和解决方案，定期回顾和改进

### 5.2 协作流程

需求分析：明确功能需求，定义性能指标，识别技术约束，确定依赖关系

技术方案：架构设计，技术选型，接口定义，实现路径规划

开发实施：环境搭建，开发任务分解，编码规范，测试验证

代码审查：自我审查，同事审查，修改反馈，最终确认

## 六、最佳实践

### 6.1 性能优化

协程使用：合理使用 yield，避免频繁的上下文切换，合并小任务为大任务

内存管理：及时释放资源，使用对象池，避免内存泄漏

I/O 优化：使用 NIO，批量处理数据，使用缓冲区

### 6.2 代码质量

可读性：清晰的命名，充分的注释，合理的代码结构

可维护性：模块化设计，接口抽象，易于扩展

可测试性：编写单元测试，集成测试，性能测试

### 6.3 持续改进

性能优化：定期进行性能分析，优化热点代码，改进算法和数据结构

功能增强：根据用户需求添加新功能，优化现有功能，提高用户体验

文档维护：及时更新开发文档，记录重要决策，维护变更日志

## 七、总结

基于 Kilim 框架的特性，团队开发需要：

深入理解协程模型，掌握消息传递机制，熟悉事件驱动架构，理解调度器工作原理

遵循开发规范，代码风格统一，注释完整，异常处理规范，Git 工作流规范

重视协程使用，避免阻塞操作，合理使用 yield，高效协作，保证代码质量

加强团队协作，规范 Git 工作流，有效沟通，知识共享，问题跟踪

持续学习改进，性能优化，功能增强，文档完善，最佳实践积累

通过遵循本指南，团队可以高效、规范地进行 Kilim 项目的开发工作，保证代码质量和项目进度。
