# Kilim JDK 17+ 迁移评估报告与实施方案

## 一、项目概述

### 1.1 背景

甲方客户需求：将 Kilim 协程框架部署运行在 JDK 17 及以上环境。当前 Kilim 版本基于 JDK 8 开发，需要进行必要的改造以兼容 JDK 17+。

### 1.2 目标

- 确保 Kilim 在 JDK 17+ 环境下正常运行
- 保持向后兼容性，支持 JDK 8-17+
- 优化性能，利用 JDK 17+ 新特性
- 确保字节码编织机制在新版本 JDK 中正常工作

## 二、现状分析

### 2.1 当前配置

从 pom.xml 可以看到：
- Maven 编译器目标版本：1.8
- ASM 版本：9.9.1（支持 JDK 17）
- JUnit 版本：4.13.2
- Jetty 版本：9.4.58.v20250814

### 2.2 核心组件分析

Kilim 的核心组件包括：
1. 字节码编织：使用 ASM 9.9.1 进行字节码操作
2. 类加载器：WeavingClassLoader 实现动态类加载
3. Java Agent：Agent 类实现运行时字节码转换
4. 协程实现：Fiber、Task 等核心类
5. 调度器：Scheduler、AffineScheduler 等调度实现

### 2.3 潜在问题识别

1. 模块系统（JPMS）兼容性
- JDK 9 引入的模块系统可能影响类加载机制
- 反射访问限制增强

2. 强封装
- JDK 16+ 对内部 API 的访问限制
- 可能影响对 sun.* 包的访问

3. 字节码版本
- 当前使用 V1_1 版本字节码
- 需要升级以支持 JDK 17+ 特性

4. 反射 API 变更
- JDK 17 对反射 API 有所限制
- 可能影响类加载和字节码操作

5. Java Agent 变更
- JDK 17+ 对 Java Agent 的加载机制有所调整
- 需要确保 Agent 在新版本中正常工作

## 三、技术评估

### 3.1 ASM 版本兼容性

当前使用的 ASM 9.9.1 版本已经支持 JDK 17，这是好消息。ASM 9.x 系列支持：
- Java 8 到 Java 17 的字节码
- 新的指令集和特性
- 模块系统支持

### 3.2 字节码版本升级

需要将字节码版本从 V1_1 升级到 V17（或 V21 以支持最新 JDK）：
- ClassWeaver.java 第 16 行：import static org.objectweb.asm.Opcodes.V1_1;
- 需要改为：import static org.objectweb.asm.Opcodes.V17;

### 3.3 模块系统适配

需要添加 module-info.java 文件，定义模块依赖：
- 需要访问 java.instrument 模块
- 需要访问 java.base 模块的反射 API
- 可能需要添加 --add-opens JVM 参数

### 3.4 反射 API 适配

需要处理 JDK 17+ 的反射限制：
- 使用 MethodHandles 替代部分反射操作
- 添加必要的 --add-opens 参数
- 考虑使用 VarHandle 替代部分反射操作

## 四、实施方案

### 4.1 阶段一：基础配置升级

#### 4.1.1 更新 pom.xml

1. 修改编译器目标版本
2. 更新依赖版本

#### 4.1.2 创建 module-info.java

在 src/main/java 目录下创建 module-info.java，定义模块依赖和导出

### 4.2 阶段二：字节码编织升级

#### 4.2.1 更新 ClassWeaver.java

修改字节码版本从 V1_1 到 V17

#### 4.2.2 更新 ClassWriter 使用

确保 ClassWriter 使用正确的标志，添加 COMPUTE_FRAMES 标志

### 4.3 阶段三：类加载器适配

#### 4.3.1 更新 WeavingClassLoader

1. 处理模块系统
2. 处理反射限制

### 4.4 阶段四：Java Agent 适配

#### 4.4.1 更新 Agent.java

1. 处理模块系统
2. 处理新的类加载器

### 4.5 阶段五：测试与验证

#### 4.5.1 单元测试

1. 更新测试框架
2. 编写 JDK 17+ 特定测试

#### 4.5.2 集成测试

1. 在不同 JDK 版本下测试
2. 测试各种场景

## 五、风险评估

### 5.1 技术风险

1. 模块系统兼容性（风险等级：中）
- 缓解措施：添加 module-info.java，使用 --add-opens 参数

2. 反射 API 限制（风险等级：中）
- 缓解措施：使用 MethodHandles，添加必要的开放参数

3. 字节码兼容性（风险等级：低）
- 缓解措施：使用 ASM 9.9.1，升级字节码版本

### 5.2 兼容性风险

1. 向后兼容性（风险等级：中）
- 缓解措施：保持多版本支持，使用多版本 JAR

2. 性能影响（风险等级：低）
- 缓解措施：性能测试，优化热点代码

## 六、实施计划

### 6.1 时间线

- 第 1 周：基础配置升级
- 第 2 周：字节码编织升级
- 第 3 周：类加载器适配
- 第 4 周：Java Agent 适配
- 第 5-6 周：测试与验证
- 第 7 周：文档更新与发布

### 6.2 里程碑

1. M1：基础配置完成
- pom.xml 更新
- module-info.java 创建
- 基础编译通过

2. M2：字节码编织完成
- ClassWeaver 更新
- 字节码版本升级
- 编织功能测试通过

3. M3：类加载器适配完成
- WeavingClassLoader 更新
- 模块系统支持
- 类加载测试通过

4. M4：Java Agent 适配完成
- Agent 更新
- Agent 加载测试通过

5. M5：测试验证完成
- 单元测试通过
- 集成测试通过
- 性能测试通过

6. M6：发布准备完成
- 文档更新
- 发布包准备
- 发布说明编写

## 七、后续优化建议

### 7.1 性能优化

1. 利用 JDK 17+ 新特性
- 记录类（Record）
- 模式匹配
- 密封类（Sealed Classes）
- 增强的伪随机数生成器

2. 优化字节码编织
- 减少不必要的字节码操作
- 优化类加载性能
- 缓存编织结果

### 7.2 功能增强

1. 添加新的协程特性
- 结构化并发
- 虚拟线程集成
- 异步编程模型增强

2. 改进工具支持
- 更好的 IDE 集成
- 增强的调试支持
- 性能分析工具

## 八、总结

本评估报告详细分析了将 Kilim 迁移到 JDK 17+ 环境所需的工作，包括：

1. 现状分析：识别了当前配置和潜在问题
2. 技术评估：评估了 ASM 版本、字节码版本、模块系统等
3. 实施方案：提供了详细的分阶段实施计划
4. 风险评估：识别了技术和兼容性风险
5. 实施计划：制定了详细的时间线和里程碑
6. 后续优化：提供了性能优化和功能增强建议

通过按照本方案实施，可以确保 Kilim 在 JDK 17+ 环境下正常运行，同时保持向后兼容性，并利用新版本 JDK 的特性提升性能和功能。
